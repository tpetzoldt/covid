---
title: "Some functions to plot JHU Covid-19 data"
date: " 2020-03-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

## Notes

* **This page is only for my personal understanding and may contain errors!**
* **Please consult the web page of the experts, e.g.: https://www.rki.de/ **
* more info: https://tpetzoldt.github.io/covid

## R packages and data

```{r}
library("dplyr")
library("readr")
library("ggplot2")
library("reshape2")
```


The data can be directly retrieved from the Github Data Repository by Johns 
Hopkins CSSE. As a first step, data are converted from a wide table format 
in a data base friendly "tidy" format with standard-conforming variable names
and an ISO 8601 conforming date format that allows computations.

```{r}
file <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv"

dat <- read_delim(file, delim=",",
                  escape_double = FALSE,
                  trim_ws = TRUE)

names(dat)[1:2] <- c("Province_State", "Country_Region")

dat2 <-
  dat %>%
  ## summarize Country/Region duplicates
  group_by(Country_Region) %>% summarise_at(vars(-(1:4)), sum) %>%
  ## make it a long table
  melt(id.vars = "Country_Region", variable.name = "time") %>%
  ## convert to ISO 8601 date
  mutate(time = as.POSIXct(time, format="%m/%e/%y"))
```

## Time series plots of raw data

As a first plot, we plot the data of a selected set of countries in linear scale

```{r}
dat2 %>%
  filter(Country_Region %in% c("Italy", "Spain","France", "Germany", "US")) %>%
  ggplot(aes(time, value, color=Country_Region)) +  geom_line()
```

and with log-transformed scale, using only counts greater 100:

```{r}
dat2 %>%
  filter(value > 100) %>%
  filter(Country_Region %in% c("China", "Italy", "Spain","France", "Germany", "US", "Korea, South")) %>%
  ggplot(aes(time, value, color=Country_Region)) + geom_line() + scale_y_log10()
```

## Rate of increase and doubling time

Now, we plot the exponential rate of increase, omitting the last day, 
because recently reported data may not yet complete

```{r}
dat2 %>%
  filter(value > 100, time < last(time)) %>%
  filter(Country_Region %in% c("China", "Italy", "Germany", "Spain", "France", "US", "Korea, South")) %>%
  mutate(log=log(value)) %>%  group_by(Country_Region) %>%
  mutate(growthrate = c(NA, diff(log)/diff(as.numeric(format(time, "%j"))))) %>%
  filter(!is.na(growthrate)) %>%
  ggplot(aes(time, growthrate, color=Country_Region)) +
  geom_point() + geom_smooth() + labs(y = "rate (1/d)")
```

Now we repeat the same, but with a delay of one week:

```{r}
## 1st derivative, delayed
lag <- 7
dat2 %>%
  filter(value > 100, time < last(time)) %>%
  filter(Country_Region %in% c("China", "Italy", "Germany", "France", "Spain", "US", "Korea, South")) %>%
  mutate(log = log(value)) %>%  group_by(Country_Region) %>%
  mutate(growthrate = c(rep(NA, lag), diff(log, lag = lag) / diff(as.numeric(format(time, "%j")), lag=lag))) %>%
  filter(!is.na(growthrate)) %>%
  ggplot(aes(time, growthrate, color=Country_Region)) +  geom_point() + geom_smooth() +  labs(y = "rate (1/d)")
```

An alternative to the rate of increase is the doubling time. Unfortunately 
smoothing can introduce artifacts, because basic statistical assumptions may be
violated. The choice of the smoother may change in the future. Note also that the
use of a ```lag``` time hides short-term variation, so one should be very careful
with interpretations. 

```{r}
lag <- 7
dat2 %>%
  filter(value > 100, time < last(time)) %>%
  filter(Country_Region %in% c("Italy", "Germany", "France", "US")) %>%
  mutate(log=log(value)) %>%
  group_by(Country_Region) %>%
  mutate(growthrate = c(rep(NA, lag), diff(log, lag = lag) / diff(as.numeric(format(time, "%j")), lag=lag))) %>%
  filter(!is.na(growthrate)) %>%
  mutate(doubling = log(2) / growthrate) %>%
  ggplot(aes(time, doubling, color=Country_Region)) +
  geom_point() +
  geom_smooth(method="gam" ,formula=y ~ s(x, bs = "cr"), se=TRUE) +
  coord_cartesian(ylim = c(-2, 10)) +
  labs(y = "doubling time (d)")
```



## References

Data source: 2019 Novel Coronavirus COVID-19 (2019-nCoV) Data Repository by Johns Hopkins CSSE,  https://github.com/CSSEGISandData/COVID-19


Dong, E., Du, H., & Gardner, L. (2020). An interactive web-based dashboard to 
track COVID-19 in real time. The Lancet Infectious Diseases, S1473309920301201.
https://doi.org/10.1016/S1473-3099(20)30120-1

**Please consult the web page of the experts, e.g.: https://www.rki.de/ **

----

Additional links and more info: https://tpetzoldt.github.io/covid

